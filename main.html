<!DOCTYPE html>
<html>
    <head>
        <title>NewSys Sheet</title>
        <link rel="stylesheet" href="src/mainstyle.css">
        <script src="src/scripts.js"></script>
        <script>
            var newChar = new Character();
            var rollSkillsStates = [false,false,false,false,false,false,false,false,false,false]
            var rollSkillButtons = []
            function UpdateCharacterSheet(){
                document.getElementById("CharacterName").innerHTML = newChar.getName();
                let charSkills = newChar.getSkills()
                let charConsequences = newChar.getConsequences()
                
                //setup Skill Table
                for(let i=0; i<newChar.getSkillLimit();i++){
                    if(charSkills[i] == null){continue;}

                    if(skillTable.rows[i+1] != null){
                        skillTable.rows[i+1].cells[0].innerHTML = charSkills[i].getName()
                        skillTable.rows[i+1].cells[1].innerHTML = skillRankDetails[charSkills[i].getRank()].name
                        skillTable.rows[i+1].cells[2].innerHTML = charSkills[i].getLevel()
                        skillTable.rows[i+1].cells[3].innerHTML = charSkills[i].getTimesUsed()
                    }else{
                        let newRow = skillTable.insertRow()
                        newRow.insertCell(0).innerHTML = charSkills[i].getName()
                        newRow.insertCell(1).innerHTML = skillRankDetails[charSkills[i].getRank()].name
                        newRow.insertCell(2).innerHTML = charSkills[i].getLevel()
                        newRow.insertCell(3).innerHTML = charSkills[i].getTimesUsed()
                    }
                }

                //setup Consequence Table
                for(let i=0;i<4;i++){
                    if(consequenceTable.rows[i] != null){
                        console.log(charConsequences[i])
                        consequenceTable.rows[i].cells[0].innerHTML = charConsequences[i]
                    }
                }
            }

            function UpdateRollOutput(){
                const textBox = document.getElementById("outputRollCodeActual")
                let skillset = newChar.getSkills()

                let outputText = "/r 1d10!"

                for(let i=0;i<newChar.getSkillLimit();i++){
                    //covers both null and false cases
                    if(rollSkillsStates[i] != true){continue;}
                    if(skillset[i] == null){continue;}

                    let rollingD10s = Math.floor(skillset[i].getLevel()/10)
                    let remaing = skillset[i].getLevel()%10
                    outputText = outputText + " + ("
                    if(rollingD10s > 0){
                        outputText = outputText + rollingD10s + "d10!";
                    }
                    if(rollingD10s > 0 && remaing != 0){
                        outputText = outputText + " + 1d" + remaing;
                    }else if(remaing != 0){
                        outputText = outputText + "1d" + remaing;
                    }
                    outputText = outputText + ")"
                }
                console.log(outputText)
                outputText =  outputText + (document.getElementById("ExtraRollCodeInput").value)
                textBox.innerHTML = outputText
            }

            function UpdateSkillButtons(){
                let skillset = newChar.getSkills()

                for(let i=0;i<newChar.getSkillLimit();i++){
                    if(rollSkillButtons[i] == null){continue;}
                    if(skillset[i] == null){continue;}

                    rollSkillButtons[i].innerHTML = skillset[i].getName();
                }
            }

            function ShowHideSubsections(sectionList,active){
                for(let i=0;i<sectionList.length;i++){
                    if(i!=active){sectionList[i].style.display = "none"}
                    else{sectionList[i].style.display = "block"}
                }
            }

            function EnableDisableNavButtons(navButtonList,active){
                for(let i=0;i<navButtonList.length;i++){
                    if(i!=active){navButtonList[i].style.backgroundColor = BUTTON_INACTIVE_COLOR}
                    else{navButtonList[i].style.backgroundColor = BUTTON_ACTIVE_COLOR}
                }
            }

        </script>
    </head>

    <body>
        <header>
            <h1>NEWSYS ROLL20 CHARACTER HELPER</h1>
            <h3>a helper site for managing characters for NewSys</h3>
        </header>
        <div class="mainSections">
            <!--CHAR SHEET / CREATE NEW / SAVE-LOAD -->
            <section id="LeftSection">
                <div class="mainSectionNavBar">
                    <button id="charSheetNavButton" onclick="showHideLeftSide(0)">CHAR SHEET</button>
                    <button id="charCreateNavButton" onclick="showHideLeftSide(1)">CREATE</button>
                    <button id="charSaveLoadNavButton" onclick="showHideLeftSide(2)">SAVE/LOAD</button>
                </div>

                <div class="subSection" id="characterSheet">
                    <div id="CharacterHeader">
                        <h1 id="CharacterName"></h1>
                    </div>
                    
                    <table id="CharTable">
                        <tr>
                            <th>Skill</th>
                            <th>Rank</th>
                            <th>Level</th>
                            <th>Used</th>
                        </tr>
                    </table>
    
                    <section id="StressBoxes">
                        <h2>STRESS</h2>
                        <button class="StressBoxButton" id="Stress1" onclick="toggleStressBox(0)">1</button>
                        <button class="StressBoxButton" id="Stress2" onclick="toggleStressBox(1)">2</button>
                        <button class="StressBoxButton" id="Stress3" onclick="toggleStressBox(2)">3</button>
                        <button class="StressBoxButton" id="Stress4" onclick="toggleStressBox(3)">4</button>

                        <script>
                            const stressBoxes = [];
                            stressBoxes[0] = document.getElementById("Stress1")
                            stressBoxes[1] = document.getElementById("Stress2")
                            stressBoxes[2] = document.getElementById("Stress3")
                            stressBoxes[3] = document.getElementById("Stress4")

                            function toggleStressBox(_pos,_state){
                                let state = false

                                //if no state given, assume flipflop
                                if(_state == null){
                                    state = newChar.getStressBoxes()[_pos]
                                    if(state ==true){
                                        state = false;
                                    }else{
                                        state = true;
                                    }
                                    newChar.setStressBox(_pos,state)
                                }else{
                                    state = _state
                                }

                                if(state == true){
                                    stressBoxes[_pos].style.backgroundColor = STRESS_BOX_ACTIVE_COLOR
                                }else{
                                    stressBoxes[_pos].style.backgroundColor = BUTTON_INACTIVE_COLOR
                                }
                            }
                        </script>
                    </section>
    
                    <table id="ConsequenceTable"></table>
                </div>

                <div class="subSection" id="charCreate" hidden>

                </div>
                
                <div class="subSection" id="charSaveLoad" hidden>
                    <input type="file" id="ImportCharacterFile"/>
                    <button id="ImportCharacterButton" onclick="importCharacter()">IMPORT</button>
                    <br>
                    <button id="ExportCharacter" onclick="downloadCharacter()">Export</button>
                    <script>
                        function importCharacter(){

                            const selectedFile = document.getElementById("ImportCharacterFile").files[0]
                            if(selectedFile == null){return false}
                            //get file extention
                            const lastDot = selectedFile.name.lastIndexOf(".")
                            const ext = selectedFile.name.substring(lastDot+1)
                            console.log(ext)
                            if(ext != CHAR_FILE_EXTENTION){return false}
        
                            const reader = new FileReader();
                            reader.readAsText(selectedFile);
                            
                            //executed when charater loaded...probably
                            let eventListener = reader.addEventListener("loadend",(event) => {
                                const newObj = JSON.parse(reader.result)
                                newChar.overwriteCharacterFromObject(newObj)

                                //update website
                                UpdateCharacterSheet()
                                UpdateSkillButtons()

                                let sb = newChar.getStressBoxes()
                                for(let i=0;i<sb.length;i++){
                                    toggleStressBox(i,sb[i])
                                }

                                reader.removeEventListener("loadend",eventListener)
                                showHideLeftSide(0)
                            });
                        }

                        function downloadCharacter() {
                            const link = document.createElement("a");
                            console.log(JSON.stringify(newChar))
                            const file = new Blob([JSON.stringify(newChar)],{type:'text/plain'});
                            link.href = URL.createObjectURL(file);
                            link.download = newChar.getName() + "." + CHAR_FILE_EXTENTION
                            link.click();
                            URL.revokeObjectURL(link.href)
                        }
                    </script>
                </div>

                <script>
                    const sections = [];
                    sections[0] = document.getElementById("characterSheet");
                    sections[1] = document.getElementById("charCreate");
                    sections[2] = document.getElementById("charSaveLoad");

                    const navButtons = [];
                    navButtons[0] = document.getElementById("charSheetNavButton")
                    navButtons[1] = document.getElementById("charCreateNavButton")
                    navButtons[2] = document.getElementById("charSaveLoadNavButton")

                    function showHideLeftSide(pos){
                        ShowHideSubsections(sections,pos);
                        EnableDisableNavButtons(navButtons,pos)
                    }

                    showHideLeftSide(0)
                </script>
            </section>

            <!-- NOTES / FIELD / STATS-->
            <section id="MiddleSection">
                <div class="mainSectionNavBar">
                    <button>NOTES</button>
                    <button>FIELD</button>
                    <button>STATS</button>
                </div>

                <div class="subSection" id="notes">
                    <input type="text" id="notesInput" name="notes" 
                    style="
                        height: auto;
                        width: 95%;
                        min-height: 90%;
                    "
                    />
                </div>
                
            </section>

            <!-- ROLL MANAGER / EXTRA RULES-->
            <section id="RightSection">
                <div class="mainSectionNavBar">
                    <button>ROLLS</button>
                    <button>EXTRA RULES</button>
                </div>
                <div class="subSection" id="rollManager">
                    <h3>Roll Style: </h3>
                    <div>
                        <label class="radioContainer">Combat
                            <input type="radio" checked="checked" name="RollTypeSelect" value="0" id="CombatRollButton">
                            <span class="checkmark"></span>
                        </label>
                        <label class="radioContainer">Non-Combat
                            <input type="radio" name="RollTypeSelect" value="1" id="NonCombatRollButton">
                            <span class="checkmark"></span>
                        </label>
                    </div>

                    <h3>Roll Skills: </h3>
                    <div id="skillsButtonDiv"></div>

                    <h3>Arbitrary Roll Code</h3>
                    <div>
                        <input type="text" id="ExtraRollCodeInput" name="extraRoll">
                        <button id="extraRollCodeSubmit" onclick="UpdateRollOutput()">SUBMIT</button>
                    </div>

                    <h3>Output Roll Code:</h3>
                    <div>
                        
                        <p id="outputRollCode"><samp id="outputRollCodeActual">OUTPUT CODE</samp></p>
                        <button id="CopyOutputRollButton" onclick="copyOutput()">Copy Code</button>

                        <script>
                            function copyOutput(){
                                const textToCopy = document.getElementById("outputRollCodeActual");
                                navigator.clipboard.writeText(textToCopy.innerHTML);
                            }
                        </script>
                    </div>

                    <script>
                        const skillsContainer = document.getElementById("skillsButtonDiv")
                        for(let i =0; i<CHAR_DEFAULT_SKILL_LIMIT;i++){
                            rollSkillButtons[i] = document.createElement("BUTTON")
                            rollSkillButtons[i].className = "skillButton"
                            rollSkillButtons[i].id = "s" + (i+1)
                            rollSkillButtons[i].innerHTML = "SKILL " + (i+1)
                            rollSkillsStates[i] = false

                            rollSkillButtons[i].addEventListener("click",function(){
                                if(rollSkillsStates[i] == true){
                                    rollSkillsStates[i] = false;
                                    rollSkillButtons[i].style.backgroundColor = BUTTON_INACTIVE_COLOR

                                }else{
                                    rollSkillsStates[i] = true;
                                    rollSkillButtons[i].style.backgroundColor = BUTTON_ACTIVE_COLOR
                                }

                                UpdateRollOutput()
                            })

                            skillsContainer.appendChild(rollSkillButtons[i])

                            if((i+1)%5 == 0){
                                skillsContainer.appendChild(document.createElement("BR"))
                            }
                        }
                    </script>
                </div>
            </section>
        </div>

        <script>
            const skillTable = document.getElementById("CharTable")
            const consequenceTable = document.getElementById("ConsequenceTable")

            for(let i=0;i<CHAR_DEFAULT_SKILL_LIMIT;i++){
                let newRow = skillTable.insertRow()
                newRow.insertCell(0).innerHTML = "NONE"
                newRow.insertCell(1).innerHTML = "X"
                newRow.insertCell(2).innerHTML = "X"
                newRow.insertCell(3).innerHTML = "X"
            }

            for(let i=0;i<4;i++){
                let newRow = consequenceTable.insertRow()
                    newRow.insertCell(0).innerHTML = "NONE"
                    newRow.insertCell(1).innerHTML = (i+1)*-3
            }
        </script>
    </body>
</html>